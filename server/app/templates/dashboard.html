<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pepper Object Detection Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="/static/pepper_icon.png"/>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-6">

    <h1 class="text-3xl font-bold mb-6">Pepper Live Object Detection Dashboard</h1>



    <div class="w-full max-w-3xl bg-white rounded shadow p-4 mb-6" id="settings">
        <h2 class="font-bold text-xl cursor-pointer flex justify-between items-center" onclick="toggleSection('settings-content')">
            Detection Settings
            <span id="settings-arrow">▼</span>
        </h2>
        <div id="settings-content" class="mt-2 hidden">
            <!-- Confidence Threshold -->
            <div class="w-full bg-gray-50 rounded shadow p-4 mb-4">
                <label class="font-bold">Confidence Threshold</label>
                <div class="flex items-center gap-4 mt-2">
                    <input type="range" id="threshold-slider" min="0" max="1" step="0.01" value="0.25" class="flex-1">
                    <input type="number" id="threshold-input" min="0" max="1" step="0.01" value="0.25" class="w-20 border rounded px-2 py-1">
                </div>
            </div>
            <!-- Model Selection -->
            <div class="w-full bg-gray-50 rounded shadow p-4 mb-4">
                <label class="font-bold">Detection Model</label>
                <select id="model-select" class="w-full border rounded px-2 py-1 mt-2">
                    <option>Loading models...</option>
                </select>
                <button id="change-model" class="mt-2 px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Change Model</button>
            </div>
            <!-- Language selection -->
            <div class="w-full bg-gray-50 rounded shadow p-4 mb-4">
                <label class="font-bold">Label Language</label>
                <select id="language-select" class="w-full border rounded px-2 py-1 mt-2">
                    <option value="en">English</option>
                    <option value="cs">Czech</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="es">Spanish</option>
                </select>
                <button id="change-language" class="mt-2 px-4 py-1 bg-blue-600 text-white rounded hover:bg-blue-600">Change Language</button>
            </div>
        </div>
    </div>
    <!-- Annotated Image - default it just random ai generted image -->
    <div class="w-full max-w-3xl relative">
        <img id="annotated-image" class="w-full h-auto rounded border border-gray-300 shadow" src="/static/pepper_icon.png" alt="Annotated Detection Image">
    </div>

    <!-- Detection Text Info -->
    <div id="detections" class="w-full max-w-3xl bg-white rounded shadow p-4 mb-6">
        <h3 class="font-bold text-lg cursor-pointer flex justify-between items-center" onclick="toggleSection('detections-content')">
            Detected Objects
            <span id="detections-arrow">▲</span>
        </h3>
        <div id="detections-content" class="mt-2">
            <p class="text-gray-500">No detections yet...</p>
        </div>
    </div>


    <script>
        const ws = new WebSocket(`ws://${location.host}/dashboard/events`);

        const detectionsContainer = document.getElementById("detections-content");
        const annotatedImage = document.getElementById("annotated-image");

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);

            // Clear previous data
            detectionsContainer.innerHTML = "";
            if (data.objects && data.objects.length > 0) {
            data.objects.forEach(obj => {
                const div = document.createElement("div");
                div.className = "obj mb-2 p-2 rounded";

                // Use color from backend colors dict
                const labelColor = data.colors && data.colors[obj.label]
                    ? `rgb(${data.colors[obj.label].join(",")})`
                    : "#ddd";

                div.style.backgroundColor = labelColor;
                div.style.color = "black";

                div.innerHTML = `<strong>${obj.label}</strong> (${obj.confidence.toFixed(2)}) - bbox: [${obj.bbox.map(x => x.toFixed(1)).join(", ")}]`;
                detectionsContainer.appendChild(div);
            });
            } else {
                detectionsContainer.innerHTML = `<p class="text-gray-500">No objects detected</p>`;
            }
            // image
            if (data.image) {
                annotatedImage.src = `data:image/jpeg;base64,${data.image}`;
                //annotatedImage.classList.remove("hidden");
            }
            //else {
            //    annotatedImage.classList.add("hidden");
            //}
        };
        const slider = document.getElementById("threshold-slider");
        const input = document.getElementById("threshold-input");

        function update_conf_threshold(value) {
          fetch("/api/config/threshold", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({threshold: value})
            });
        }
        slider.addEventListener("input", () => {
            input.value = slider.value;
            update_conf_threshold(parseFloat(slider.value));
        });

        // slider update
        input.addEventListener("change", () => {
            let val = parseFloat(input.value);
            if (isNaN(val)) val = 0; // invalid numbers
            if (val < 0) val = 0;
            if (val > 1) val = 1;
            input.value = val.toFixed(2);
            slider.value = val.toFixed(2);
            update_conf_threshold(val.toFixed(2));
        });
        const modelSelect = document.getElementById("model-select");
        const changeModelButton = document.getElementById("change-model");

        //get available models from server
        async function fetchModels() {
            try {
                const res = await fetch("/dashboard/config/get_models");
                const data = await res.json();
                modelSelect.innerHTML = "";
                data.models.forEach(model => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.textContent = model;
                    modelSelect.appendChild(opt);
                });
            } catch(err) {
                console.error("Failed to fetch models:", err);
                modelSelect.innerHTML = "<option>Error loading models</option>";
            }
        }

        // Switch model
        changeModelButton.addEventListener("click", async () => {
            const selectedModel = modelSelect.value;
            try {
                const res = await fetch("/api/config/model", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({model: selectedModel})
                });
                const data = await res.json();
                // this will pop up window, maybe add progress bar?
                if (data.ok) {
                    alert(`Model changed to: ${data.selected_model}`);
                } else {
                    alert(`Failed to change model: ${data.error}`);
                }
            } catch(err) {
                console.error("Error changing model:", err);
                alert("Error changing model");
            }
        });

        // initial model fetching
        fetchModels();

        // language setting
        const languageSelect = document.getElementById("language-select");
        const changeLanguageButton = document.getElementById("change-language");

        // Switch language
        changeLanguageButton.addEventListener("click", async () => {
            const selectedLang = languageSelect.value;
            try {
                const res = await fetch("/api/config/language", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({language: selectedLang})
                });
                const data = await res.json();
                if (data.ok) {
                    alert(`Language changed to: ${data.language}`);
                } else {
                    alert(`Failed to change language: ${data.error || "unknown error"}`);
                }
            } catch(err) {
                console.error("Error changing language:", err);
                alert("Error changing language");
            }
        });

        // collapsable utility
        function toggleSection(id) {
            const content = document.getElementById(id);
            const arrow = document.getElementById(id.replace('-content','-arrow'));
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                arrow.textContent = '▲';
            } else {
                content.classList.add('hidden');
                arrow.textContent = '▼';
            }
        }
    </script>

</body>
</html>
